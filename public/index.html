<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CCC - Graph Execution (Debug Mode)</title>
</head>
<body>
  <h1>CCC - Graph Execution</h1>

  <label for="crisisDocumentId">Crisis document ID</label><br />
  <input type="text" id="crisisDocumentId" value="dky8i3O..." style="width: 400px;" /><br /><br />

  <label for="graphSelect">Select graph</label><br />
  <select id="graphSelect" style="width: 400px;">
    <!-- options dynamically populated -->
  </select><br /><br />

  <label for="graphInput">Graph inputs (JSON)</label><br />
  <textarea id="graphInput" style="width: 400px; height: 150px;">{ "input": "Testme" }</textarea><br /><br />

  <button onclick="runGraph()">Run graph</button>

  <h2>Outputs</h2>
  <pre id="outputs">(no outputs returned)</pre>

  <h2>Errors</h2>
  <pre id="errors">[]</pre>

  <h2>Full API Response (Debug)</h2>
  <pre id="fullResponse">[waiting for response]</pre>

  <script>
    async function fetchGraphs() {
      try {
        const res = await fetch("/api/graphs");
        const json = await res.json();
        const select = document.getElementById("graphSelect");
        select.innerHTML = "";
        json.graphs.forEach(g => {
          const opt = document.createElement("option");
          opt.value = g.id;
          opt.textContent = `${g.name} (${g.id})`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to load graphs:", err);
      }
    }

    async function runGraph() {
      const crisisDocumentId = document.getElementById("crisisDocumentId").value;
      const graph = document.getElementById("graphSelect").value;
      const inputText = document.getElementById("graphInput").value;

      let inputs = {};
      try {
        inputs = JSON.parse(inputText);
      } catch (err) {
        alert("Invalid JSON input!");
        return;
      }

      const payload = {
        graph,
        crisisDocumentId,
        inputs
      };

      console.log("ðŸ“¤ Sending to /api/run:", payload);

      document.getElementById("fullResponse").textContent = "[waiting for response...]";

      const res = await fetch("/api/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();

      console.log("ðŸ“¥ Response from /api/run:", json);

      document.getElementById("fullResponse").textContent = JSON.stringify(json, null, 2);

      if (json.outputs && Object.keys(json.outputs).length > 0) {
        document.getElementById("outputs").textContent = JSON.stringify(json.outputs, null, 2);
      } else {
        document.getElementById("outputs").textContent = "(no outputs returned)";
      }

      if (json.errors && json.errors.length > 0) {
        document.getElementById("errors").textContent = JSON.stringify(json.errors, null, 2);
      } else {
        document.getElementById("errors").textContent = "[]";
      }
    }

    fetchGraphs();
  </script>
</body>
</html>