<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CCC – Graph Runner</title>
  <style>
    body{font-family:sans-serif;max-width:720px;margin:2rem auto;padding:0 1rem}
    label{font-weight:600;margin-top:1.25rem;display:block}
    input,select,textarea,button{width:100%;font-size:1rem;margin-top:.25rem}
    textarea{font-family:monospace;padding:.75rem;white-space:pre}
    button{padding:.6rem;margin-top:1rem}
    pre{background:#f5f5f5;padding:1rem;white-space:pre-wrap}
    #spinner{display:none;text-align:center;font-weight:600;margin:1rem 0}
  </style>
</head>
<body>
<h1>CCC – Graph Runner</h1>

<!-- Debugger trigger (kept at top) -->
<button id="startDebuggerBtn">Start Debugger (Local only)</button>
<hr/>

<label>Crisis document ID
  <input id="crisisId" value="dky8i30kisowxhuupwo8iz5l" />
</label>

<label>Select graph
  <select id="graphSelect"><option>Loading…</option></select>
</label>

<!-- NEW: simple string input -->
<label>Simple string input
  <input id="plainInput" placeholder="e.g. Hello graph!" />
</label>
<button id="runStringBtn">Run with String</button>

<label>Graph inputs (JSON)
  <textarea id="jsonInput" rows="8">{}</textarea>
</label>
<button id="runJsonBtn">Run with JSON</button>

<div id="spinner">⏳ Running graph…</div>

<h2>Outputs</h2>
<pre id="outputs">(waiting)</pre>

<h2>Errors</h2>
<pre id="errors">[]</pre>

<script>
async function loadGraphs(){
  try{
    const res = await fetch('/api/graphs');
    const { graphs=[] } = await res.json();
    const sel = document.getElementById('graphSelect');
    sel.innerHTML='';
    graphs.sort((a,b)=>a.name.localeCompare(b.name)).forEach(g=>{
      const opt=document.createElement('option');
      opt.value=g.id;
      opt.textContent=`${g.name||'Untitled'} (${g.id})`;
      sel.appendChild(opt);
    });
  }catch(e){console.error('Graph list error',e);}
}
loadGraphs();

function show(outId,text){
  document.getElementById(outId).textContent =
    typeof text==='string' ? text : JSON.stringify(text,null,2);
}

async function callRun(body){
  document.getElementById('spinner').style.display='block';
  show('outputs','(waiting)');
  show('errors','[]');
  try{
    const res = await fetch('/api/run',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const json = await res.json();
    show('outputs', json.outputs || '(no outputs)');
    show('errors',  json.errors  || '[]');
  }catch(e){
    show('errors',{ message:'Fetch failed', error:e.message});
  }finally{
    document.getElementById('spinner').style.display='none';
  }
}

document.getElementById('runStringBtn').onclick = () => {
  const graphId = graphSelect.value;
  const txt      = document.getElementById('plainInput').value;
  const crisisId = crisisId.value.trim();
  callRun({
    graph: graphId,
    inputs: { input: txt, crisisId }
  });
};

document.getElementById('runJsonBtn').onclick = () => {
  const graphId = graphSelect.value;
  const crisisId= crisisId.value.trim();
  try{
    const jsonInputs = JSON.parse(document.getElementById('jsonInput').value||'{}');
    if(crisisId) jsonInputs.crisisId = crisisId;
    callRun({ graph: graphId, inputs: jsonInputs });
  }catch(e){
    alert('Invalid JSON: '+e.message);
  }
};

/* Optional local-only debugger starter */
document.getElementById('startDebuggerBtn').onclick = async ()=>{
  try{
    await fetch('/api/start-debugger',{method:'POST'});
    alert('Debugger trigger sent. (On Vercel this does nothing.)');
  }catch(e){console.warn(e);}
};
</script>
</body>
</html>