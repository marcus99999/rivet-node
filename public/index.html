<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CCC - Graph Execution</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px;">
  <h1>CCC - Graph Execution</h1>

  <button id="start-debugger-btn" style="padding: 6px 12px; margin-bottom: 10px;">Start Debugger (Local Only)</button>

  <div>
    <label for="crisisId">Crisis document ID</label><br />
    <input type="text" id="crisisId" style="width: 400px;" /><br /><br />

    <label for="graphSelect">Select graph</label><br />
    <select id="graphSelect" style="width: 400px;"></select><br /><br />

    <label for="graphInputs">Graph inputs (JSON)</label><br />
    <textarea id="graphInputs" rows="8" cols="80">{}</textarea><br /><br />

    <button id="runGraphBtn">Run graph</button>
  </div>

  <h2>Outputs</h2>
  <pre id="outputs">(no outputs yet)</pre>

  <h2>Errors</h2>
  <pre id="errors">[]</pre>

  <script>
    async function loadGraphs() {
      try {
        const res = await fetch("/api/graphs");
        const json = await res.json();

        const select = document.getElementById("graphSelect");
        select.innerHTML = "";
        json.graphs.forEach((graph) => {
          const option = document.createElement("option");
          option.value = graph.id;
          option.textContent = `${graph.name} (${graph.id})`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Failed to load graphs:", err);
      }
    }

    async function runGraph() {
      const crisisId = document.getElementById("crisisId").value;
      const graphId = document.getElementById("graphSelect").value;
      const inputsRaw = document.getElementById("graphInputs").value;

      let inputs;
      try {
        inputs = JSON.parse(inputsRaw);
      } catch (err) {
        alert("Invalid JSON in Graph Inputs");
        return;
      }

      // Include crisisId in inputs if provided
      if (crisisId) {
        inputs.crisisId = crisisId;
      }

      try {
        const res = await fetch("/api/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            graphId,
            inputs,
          }),
        });

        const json = await res.json();

        console.log("ðŸ“¦ Graph outputs:", json.outputs);

        document.getElementById("outputs").textContent = JSON.stringify(
          json.outputs || {},
          null,
          2
        );
        document.getElementById("errors").textContent = JSON.stringify(
          json.errors || [],
          null,
          2
        );
      } catch (err) {
        console.error("Failed to run graph:", err);
      }
    }

    async function startDebugger() {
      try {
        await fetch("/api/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            graphId: "dummy",
            inputs: {},
          }),
        });
        console.log("Debugger triggered (check terminal)");
      } catch (err) {
        console.error("Failed to trigger debugger:", err);
      }
    }

    document.getElementById("runGraphBtn").addEventListener("click", runGraph);
    document.getElementById("start-debugger-btn").addEventListener("click", startDebugger);

    loadGraphs();
  </script>
</body>
</html>