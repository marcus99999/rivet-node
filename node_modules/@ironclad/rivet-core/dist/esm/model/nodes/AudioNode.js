import {} from '../NodeBase.js';
import { NodeImpl } from '../NodeImpl.js';
import { nanoid } from 'nanoid/non-secure';
import {} from '../../index.js';
import { base64ToUint8Array, expectType } from '../../utils/index.js';
import { nodeDefinition } from '../NodeDefinition.js';
import { getInputOrData } from '../../utils/inputs.js';
export class AudioNodeImpl extends NodeImpl {
    static create() {
        return {
            id: nanoid(),
            type: 'audio',
            title: 'Audio',
            visualData: { x: 0, y: 0, width: 300 },
            data: {
                useDataInput: false,
                useMediaTypeInput: false,
            },
        };
    }
    getInputDefinitions() {
        const inputDefinitions = [];
        if (this.chartNode.data.useDataInput) {
            inputDefinitions.push({
                id: 'data',
                title: 'Data',
                dataType: 'string',
                coerced: false,
            });
        }
        if (this.chartNode.data.useMediaTypeInput) {
            inputDefinitions.push({
                id: 'mediaType',
                title: 'Media Type',
                dataType: 'string',
                coerced: false,
            });
        }
        return inputDefinitions;
    }
    getOutputDefinitions() {
        return [
            {
                id: 'data',
                title: 'Audio Data',
                dataType: 'audio',
            },
        ];
    }
    getEditors() {
        return [
            {
                type: 'fileBrowser',
                label: 'Audio File',
                dataKey: 'data',
                mediaTypeDataKey: 'mediaType',
                useInputToggleDataKey: 'useDataInput',
                accept: 'audio/*',
            },
            {
                type: 'string',
                label: 'Media Type',
                dataKey: 'mediaType',
                useInputToggleDataKey: 'useMediaTypeInput',
            },
        ];
    }
    static getUIData() {
        return {
            contextMenuTitle: 'Audio',
            group: 'Data',
            infoBoxTitle: 'Audio Node',
            infoBoxBody: 'Defines an audio sample for use with other nodes. Can convert a binary type into an audio type.',
        };
    }
    async process(inputData, context) {
        let data;
        const mediaType = getInputOrData(this.data, inputData, 'mediaType', 'string') || 'audio/wav';
        if (this.chartNode.data.useDataInput) {
            data = expectType(inputData['data'], 'binary');
        }
        else {
            const dataRef = this.data.data?.refId;
            if (!dataRef) {
                throw new Error('No data ref');
            }
            const encodedData = context.project.data?.[dataRef];
            if (!encodedData) {
                throw new Error(`No data at ref ${dataRef}`);
            }
            data = base64ToUint8Array(encodedData);
        }
        return {
            ['data']: {
                type: 'audio',
                value: { data, mediaType },
            },
        };
    }
}
export const audioNode = nodeDefinition(AudioNodeImpl, 'Audio');
